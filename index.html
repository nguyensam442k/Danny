<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signal Board — m15 (BTC/ETH)</title>
  <link rel="stylesheet" href="./assets/style.css" />
  <style>
    .panel { background:#0d1117; border:1px solid #1f2633; border-radius:12px; padding:16px; margin:16px 0; }
    .panel-title { font-size:18px; font-weight:700; margin-bottom:10px; }
    .toolbar { display:flex; gap:8px; margin-bottom:10px; }
    .table { width:100%; border-collapse: collapse; }
    .table th,.table td { padding:10px 12px; border-bottom:1px solid #1f2633; text-align:left; }
    .table thead th { color:#9fb3c8; font-weight:600; border-bottom:1px solid #293447; }
    .green { color:#2ecc71; } .red { color:#ff6262; }
    .btn { background:#1f6feb; color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
    .btn-outline { background:transparent; border:1px solid #2f3b50; color:#9fb3c8; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media(max-width: 960px){ .grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <main class="container" style="max-width:1200px; margin:0 auto; padding:24px">

    <div style="display:flex; align-items:center; gap:12px; justify-content:space-between">
      <h1 style="margin:0">Signal Board — m15 (BTC/ETH)</h1>
      <button id="btn-refresh" class="btn">Refresh</button>
    </div>

    <!-- ======== TỔNG HỢP LIVE (từ journal) ======== -->
    <section class="panel">
      <div class="panel-title">Tổng hợp thống kê (LIVE)</div>
      <div id="summary-live"></div>
      <div style="font-size:12px; color:#9fb3c8; margin-top:6px">
        Ghi lệnh khi có tín hiệu; tính P&amp;L theo 100U × 25, TP/SL/Expiry 4h (giống khối lệnh).
      </div>
    </section>

    <!-- ======== 2 CARD tín hiệu (bạn vẫn render như cũ) ======== -->
    <section class="grid" id="cards-root">
      <!-- nơi UI hiện 2 card của BTC/ETH như bạn đã làm -->
    </section>

    <!-- ======== LỊCH SỬ LỆNH ======== -->
    <section class="panel">
      <div class="panel-title">Lịch sử lệnh</div>
      <div class="toolbar">
        <button id="btn-export" class="btn-outline">Export CSV</button>
        <button id="btn-clear" class="btn-outline">Xóa lịch sử (giữ lệnh ACTIVE)</button>
      </div>
      <table id="hist-table" class="table">
        <thead>
          <tr>
            <th>Time</th><th>Sym</th><th>Dir</th><th>Entry</th><th>TP</th><th>SL</th>
            <th>Exit</th><th>Reason</th><th>Status</th><th>P&amp;L ($)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <!-- Vùng script: giữ nguyên các file bạn đã có -->
  <script type="module" src="./js/journal.js"></script>
  <!-- ui.js của bạn (đã có từ trước) phải load SAU journal.js -->
  <script type="module">
    // ===== CHỈ THÊM: hook các nút hiển thị từ journal =====
    import { loadJournal, saveJournal, renderSummaryTable, renderHistoryTable } from './js/journal.js';

    // Export CSV
    document.getElementById('btn-export').onclick = () => {
      const j = loadJournal().filter(x => x.status !== 'ACTIVE');
      const rows = [
        ['Time','Sym','Dir','Entry','TP','SL','Exit','Reason','Status','PnLUSD'],
        ...j.map(x => [
          new Date(x.exitAt||x.createdAt).toISOString(),
          x.sym, x.dir, x.entry, x.tp, x.sl, x.exitPx, x.reason, x.status, x.pnl
        ])
      ];
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'journal.csv';
      a.click();
    };

    // Xóa toàn bộ lệnh đã kết thúc
    document.getElementById('btn-clear').onclick = () => {
      const keepActive = loadJournal().filter(x => x.status === 'ACTIVE');
      saveJournal(keepActive);
      renderSummaryTable();
      renderHistoryTable();
    };

    // Nút refresh chung (gọi refresh() của UI cũ — nếu bạn đã có)
    const btn = document.getElementById('btn-refresh');
    btn?.addEventListener('click', () => {
      // Tùy app của bạn; qua đây chỉ để click cho sướng :)
      // Bạn vẫn gọi refresh() ở file ui.js của bạn như cũ.
      window.dispatchEvent(new Event('app:refresh'));
    });

    // Lần đầu vào: vẽ summary & history
    renderSummaryTable();
    renderHistoryTable();
  </script>
  <script type="module" src="./js/ui.js"></script>
</body>
</html>
